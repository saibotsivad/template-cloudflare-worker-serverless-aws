import { createAwsSigner } from 'sign-aws-requests'

const makeRequest = async ({ sign, region }, params, type) => {
	const request = {
		url: `https://dynamodb.${region}.amazonaws.com`,
		method: 'POST',
		headers: {
			'Content-Type': 'application/x-amz-json-1.0',
			'X-Amz-Target': `DynamoDB_20120810.${type}`,
			Host: `dynamodb.${region}.amazonaws.com`
		},
		body: JSON.stringify(params)
	}
	const { authorization } = await sign(request)
	request.headers.Authorization = authorization
	return fetch(request.url, {
		method: request.method,
		headers: request.headers,
		body: request.body
	})
}

export function dynamodb ({ region, secret, id }) {
	const sign = createAwsSigner({
		config: {
			service: 'dynamodb',
			region: region,
			secretAccessKey: secret,
			accessKeyId: id
		}
	})
	const options = { sign, region }
	return {
		getItem: async params => makeRequest(options, params, 'GetItem')
	}
}
