import { dynamodb } from 'shared/dynamodb.js'

const html = data => `<!DOCTYPE html>
<html>
	<body>
		<h1>Hello World 3</h1>
		<p>The HTML is generated with a Worker, the code is generated with Rollup.</p>
		<p>Data from DynamoDB:</p>
		<pre>${JSON.stringify(data, undefined, 2)}</pre>
	</body>
</html>
`

export async function handleRequest() {
	const credentials = JSON.parse(await CREDENTIALS.get('example-iam-keys'))
	const { getItem } = dynamodb(credentials)

	const dynamodbResponse = await getItem({
		TableName: 'template-cloudflare-worker-serverless-aws',
		Key: {
			DemoPrimaryKey: { S: 'DEMO' },
			DemoSortKey: { S: '123' }
		}
	})

	let data = null
	try {
		data = await dynamodbResponse.json()
	} catch (e) {
		// ignore
	}

	return new Response(html(data), {
		headers: {
			'content-type': 'text/html;charset=UTF-8'
		}
	})
}
